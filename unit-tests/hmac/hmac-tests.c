/*
 * Copyright (C) 2018-2019 Zhiyi Zhang, Hanwen Zhang
 *
 * This file is subject to the terms and conditions of the GNU Lesser
 * General Public License v2.1. See the file LICENSE in the top level
 * directory for more details.
 */

#include "hmac-tests.h"
#include "ndn-lite/security/ndn-lite-hmac.h"
#include "../CUnit/CUnit.h"
#include "../CUnit/Basic.h"
#include <string.h>

void
hmac_test_case_1(void)
{
  uint8_t secret[] = {
    0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
    0x0b,0x0b,0x0b,0x0b
  };
  uint8_t salt[] = {0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c};
  uint8_t info[] = {0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9};
  uint8_t result[42] = {0};
  uint8_t expected[] = {0x3c,0xb2,0x5f,0x25,0xfa,0xac,0xd5,0x7a,0x90,0x43,
                        0x4f,0x64,0xd0,0x36,0x2f,0x2a,0x2d,0x2d,0x0a,0x90,
                        0xcf,0x1a,0x5a,0x4c,0x5d,0xb0,0x2d,0x56,0xec,0xc4,
                        0xc5,0xbf,0x34,0x00,0x72,0x08,0xd5,0xb8,0x87,0x18,
                        0x58,0x65};
  int ret = ndn_hkdf(secret, sizeof(secret), result, 42, salt, sizeof(salt), info, sizeof(info));
  CU_ASSERT_EQUAL(ret, 0);
  if (memcmp(result, expected, 42) != 0) {
    CU_FAIL("HMAC run_test_case_1: HKDF function logic is wrong");
  }
}

void
hmac_test_case_2(void)
{
  uint8_t secret[] = {
    0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,0x0b,
    0x0b,0x0b,0x0b,0x0b
  };
  uint8_t result[42] = {0};
  uint8_t expected[] = {0x8d,0xa4,0xe7,0x75,0xa5,0x63,0xc1,0x8f,0x71,0x5f,0x80,0x2a,0x06,0x3c,0x5a,0x31,
          0xb8,0xa1,0x1f,0x5c,0x5e,0xe1,0x87,0x9e,0xc3,0x45,0x4e,0x5f,0x3c,0x73,0x8d,0x2d,
          0x9d,0x20,0x13,0x95,0xfa,0xa4,0xb6,0x1a,0x96,0xc8};
  int ret = ndn_hkdf(secret, sizeof(secret), result, 42, NULL, 0, NULL, 0);
  CU_ASSERT_EQUAL(ret, 0);
  if (memcmp(result, expected, 42) != 0) {
    CU_FAIL("HMAC run_test_case_2: HKDF function logic is wrong");
  }
}

void add_hmac_test_suite(void)
{
  CU_pSuite pSuite = NULL;

  /* add a suite to the registry */
  pSuite = CU_add_suite("HMAC Test", NULL, NULL);
  if (NULL == pSuite)
  {
    CU_cleanup_registry();
    // return CU_get_error();
    return;
  }
  if (NULL == CU_add_test(pSuite, "hmac_test_case_1", hmac_test_case_1) ||
      NULL == CU_add_test(pSuite, "hmac_test_case_2", hmac_test_case_2))
  {
    CU_cleanup_registry();
    // return CU_get_error();
    return;
  }
}